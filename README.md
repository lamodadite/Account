# Account
계좌 시스템 개발 실습

<aside>
💡 계좌(Account) 시스템의 전반적인 구조와 기능 구현

</aside>

## 활용 기술

- Spring boot 2.6.x (JDK 11)
- Gradle
- Junit5
- H2 Database
- JPA
- Redis
- Mockito
- Lombok

## 엔티티 구조

![image](https://user-images.githubusercontent.com/102534186/184944651-6ebfb88e-41ac-4417-b3de-74caae5b40ab.png)

## 제공하는 기능(API)

### 계좌(Account) 관련 기능

1. 계좌 생성
2. 계좌 해지
3. 계좌 확인

### 계좌(Transaction) 관련 기능

1. 잔액 사용 (거래 생성)
2. 잔액 사용 취소 (거래 취소)
3. 거래 확인

### 사용자 관련 기능

→ 구현 간소화를 위해 DB에 데이터 자동 입력하도록 구현

# 프로젝트 요구사항

## 사업 기획

```java
Account(계좌) 시스템은 사용자와 계좌의 정보를 저장하고 있으며,
외부 시스템에서 거래를 요청할 경우 거래 정보를 받아서 계좌에서 잔액을 거래금액만큼 줄이거나(결제),
거래금액만큼 늘리는(결제 취소) 거래 관리 기능을 제공하는 시스템입니다.

크게 사용자, 계좌, 거래의 정보를 저장해야 합니다.

사용자는 신규 등록, 해지, 중지, 사용자 정보 조회 등의 기능을 제공해야 하지만
최초 버전에서는 빠른 서비스 오픈을 위해 사용자 등록, 해지, 중지 기능은 제공하지 않고
DB로 수기 입력을 합니다.

계좌는 계좌 추가, 해지, 확인 기능을 제공합니다. 한 사용자는 최대 10개의 계좌를 가질 수 있고
그 이상의 계좌는 생성하지 못한다. 계좌 번호는 10자리의 정수로 이루어지며 중복이 불가능하다.
빠르고 안정적인 진행을 위해 계좌번호는 순차 증가하도록 한다.

거래는 잔액 사용, 잔액 사용 취소, 거래 확인 기능을 제공합니다.
```

### 기술 스택

- Spring boot와 Java를 활용합니다.
- DB는 H2 DB(memory DB 모드)를 활용합니다.
- DB를 접근하는 방법은 Spring data jpa를 활용합니다.
- Embedded redis를 활용합니다.
- API Request body와 Response body는 json 타입으로 표현합니다.
- 각각의 API들은 각자의 요청과 응답 객체 구조를 갖습니다.
    - 다만, 요청을 처리하다가 실패하는 경우의 응답은 공통된 구조를 갖도록 합니다.

### 기능별 구체적인 명세

- 사용자
    - 구현의 편의를 위해 사용자 정보가
    어플리케이션 구동될 때 자동으로 저장되도록 하자.
- 계좌
    - 계좌 생성 API
        - POST / account
        - 파라미터 : 사용자 아이디, 초기 잔액
        - 정책 : 사용자가 없는 경우, 계좌가 10개인 경우 실패 응답
        - 성공 응답 : 사용자 아이디, 계좌번호, 등록일시
    - 계좌 해지API
        - DELETE / account
        - 파라미터 : 사용자 아이디, 계좌 번호
        - 정책 : 사용자 또는 계좌가 없는 경우, 사용자 아이디와 계좌 소유주가 다른 경
        우, 계좌가 이미 해지 상태인 경우, 잔액이 있는 경우 실패 응답
        - 성공 응답 : 사용자 아이디, 계좌번호, 해지일시
    - 계좌 확인 API
        - get / account?user_id={userId}
        - 파라미터 : 사용자 아이디
        - 정책 : 사용자 없는 경우 실패 응답
        - 성공 응답 : List<계좌번호, 잔액> 구조로 응답
- 거래 정보
    - 잔액 사용
        - POST /transaction/use
        - 파라미터 : 사용자 아이디, 계좌 번호, 거래 금액
        - 정책 : 사용자 없는 경우, 사용자 아이디와 계좌 소유주가 다른 경우, 계좌가 이
        미 해지 상태인 경우, 거래금액이 잔액보다 큰 경우, 거래금액이 너무 작거나
        큰 경우 실패 응답
            - 해당 계좌에서 거래(사용, 사용 취소)가 진행 중일 때 다른 거래 요청이 오
            는 경우 해당 거래가 동시에 잘못 처리되는 것을 방지해야 한다.
        - 성공 응답: 계좌번호, 거래 결과 코드(성공/실패), 거래 아이디, 거래금액, 거래
        일시
    - 잔액 사용 취소 API
        - POST /transaction/cancel
        - 파라미터 : 거래 아이디, 취소 요청 금액
        - 정책 : 거래 아이디에 해당하는 거래가 없는 경우, 거래금액과 거래 취소 금액
        이 다른경우(부분 취소 불가능) 실패 응답
            - 1년이 넘은 거래는 사용 취소 불가능
        - 성공 응답: 계좌번호, 거래 결과 코드(성공/실패), 거래 아이디, 거래금액, 거래
        일시
    - 거래 확인 API
        - GET /transaction/{transactionId}
        - 파라미터 : 거래 아이디
        - 정책 : 해당 거래 아이디의 거래가 없는 경우 실패 응답
        - 성공 응답 : 계좌번호, 거래종류(잔액 사용, 잔액 사용 취소), 거래 결과 코드 (성공/실패), 거래 아이디, 거래금액, 거래일시
            - 실패한 거래(사용/사용취소)도 거래를 확인할 수 있도록 합니다.
            
# 설계 및 기본 구조 개발

## 패키지 구조

<aside>
💡 향후 구성될 패키지의 모습 (일반적으로 많이 구성하는 구조)

</aside>

```java
- aop : AOP로 중복 거래 방지 락을 걸 때 사용될 어노테이션 등을 위치시킴
- config : redis 관련 설정 및 클라이언트 빈 등록, JPA 관련 설정 등록
- controller : API의 endpoint를 등록하고, 요청/응답의 형식을 갖는 클래스 패키지
- domain : jpa entity
- dto : DTO(Data Transafer Object)를 위치시키는 곳
* Controller에서 요청/응답에 사용할 클래스
* 로직 내부에서 데이터 전송에 사용할 클래스
- exception : 커스텀 Exception, Exception Handler 클래스 패키지
- repository : Repository(DB에 연결할 때 사용하는 인터페이스)가 위치하는 패키지
- service : 비즈니스 로직을 담는 서비스 클래스 패키지
- type : 상태타입, 에러코드, 거래종류 등의 다양한 enum class들의 패키지
```

## 기본 구조 개발

- 일반적으로 프로젝트 시작 후 하는 일(스프링의 경우)
    - 스프링 프로젝트 생성
    - 팀 코딩 컨벤션 정책 합의
    - 기본 패키지(뼈대) 구조 생성
    - DB 접속 정보 확인 및 설정
    - 각종 연동 API 확인 및 검토

### 우리의 경우

- 스프링 프로젝트 생성 및 기본적인 패키지 생성이 완료된 상태
- DB 접속은 H2이고, 접속 정보 입력됨
- 외부 API 연동은 다루지 않기 때문에 해당 안됨
- 코딩 컨벤션은 Intellij java 기본 컨벤션에서 hard wrap만 120에서 80으로 축소(멀티 윈도우 사용의 편의를 위해)
